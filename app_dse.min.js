async function updateTime(e){const t=Parse.Object.extend("Stock"),s=new Parse.Query(t),a=await s.findAll();console.log("Updating time of Stock class..");for(let t=0;t<a.length;t++)a[t].set("upTime",e),await a[t].save().catch(function(e){console.log("updateTime error: "+e.message),emailTrigger(!0)})}async function updateStockPrice(e,t){const s=Parse.Object.extend("StockPrice"),a=new Parse.Query(s);await updateTime(e);const o=await a.findAll();console.log("Stocks Price updating..");for(let e=0;e<t.length;e++)o[e].set("LTP",t[e].LTP),o[e].set("HIGH",t[e].HIGH),o[e].set("LOW",t[e].LOW),o[e].set("CLOSEP",t[e].CLOSEP),o[e].set("YCP",t[e].YCP),o[e].set("CHANGE",t[e].CHANGE),o[e].set("TRADE",t[e].TRADE),o[e].set("VALUE",t[e].VALUE),o[e].set("VOLUME",t[e].VOLUME),await o[e].save().catch(function(e){console.log("updateStockPrice error: "+e.message),emailTrigger(!0)});console.log("updateStockPrice: Done!!")}async function updateDateTime(e,t){const s=Parse.Object.extend("Stock"),a=new Parse.Query(s),o=await a.findAll();console.log("Updating date & time of Stock class..");for(let s=0;s<o.length;s++)o[s].set("upDate",e),o[s].set("upTime",t),await o[s].save().catch(function(e){console.log("updateDateTime error: "+e.message),emailTrigger(!0)})}async function queryForStockObjectId(e){const t=Parse.Object.extend("Stock"),s=new Parse.Query(t),a=await s.find();for(let t=0;t<a.length;t++){s.equalTo("TRADING_CODE",e);const t=await s.first();if(t)return t;console.log("TRADING_CODE not found in 'Stock' class.!!");break}}async function insertStockPrice(e,t,s){const a=s.length;await updateDateTime(e,t),console.log("Stocks Price inserting..");for(let e=0;e<a;e++){const t=Parse.Object.extend("StockPrice"),a=new t;for(let t=e;t<e+1;){a.set("TRADING_CODE",s[e].TRADING_CODE),a.set("LTP",s[e].LTP),a.set("HIGH",s[e].HIGH),a.set("LOW",s[e].LOW),a.set("CLOSEP",s[e].CLOSEP),a.set("YCP",s[e].YCP),a.set("CHANGE",s[e].CHANGE),a.set("TRADE",s[e].TRADE),a.set("VALUE",s[e].VALUE),a.set("VOLUME",s[e].VOLUME);const t=await queryForStockObjectId(s[e].TRADING_CODE);a.set("RELATE_TO",t),await a.save().catch(function(e){console.log("insertStockPrice error: "+e.message),emailTrigger(!0)});break}}console.log("insertStockPrice: Done!!")}async function readDateTime(e,t,s){const a=Parse.Object.extend("Stock"),o=new Parse.Query(a),r=await o.first();let c=r.get("upDate"),i=r.get("upTime");return console.log("Date: "+c+" and Time: "+i),c==e&&i==t?(console.log("Everything is up-to-date\n"),0):c==e&&i!=t?(console.log("updateStockPrice: Activated!"),updateStockPrice(t,s),0):(console.log("insertStockPrice: Activated!"),insertStockPrice(e,t,s),0)}async function main(){await request("https://www.dsebd.org/latest_share_price_scroll_l.php",(e,t,s)=>{if(e||200!=t.statusCode)console.log(e);else{const e=cheerio.load(s),t=[],a=e(".BodyHead"),o=a.first().text().split(" "),r=o[0]+" "+o[1]+" "+o[2]+" "+o[3];if("Latest Share Price On"==r){const s=o[4]+" "+o[5]+" "+o[6],a=o[8]+" "+o[9];e("html>body>div>section>div>div>div>div>div>table>tbody>tr").each((s,a)=>{const o=e(a).find("td"),r=e(o[1]).text().replace(/\s\s+/g,""),c=e(o[2]).text().replace(/\s\s+/g,""),i=e(o[3]).text().replace(/\s\s+/g,""),n=e(o[4]).text().replace(/\s\s+/g,""),l=e(o[5]).text().replace(/\s\s+/g,""),g=e(o[6]).text().replace(/\s\s+/g,""),d=e(o[7]).text().replace(/\s\s+/g,""),p=e(o[8]).text().replace(/\s\s+/g,""),u=e(o[9]).text().replace(/\s\s+/g,""),P=e(o[10]).text().replace(/\s\s+/g,"").replace(/,+/g,"");var T=parseFloat(c),E=parseFloat(i),f=parseFloat(n),O=parseFloat(l),S=parseFloat(g),m=parseFloat(d),L=parseFloat(p),A=parseFloat(u),D=parseFloat(P);const k={TRADING_CODE:r,LTP:T,HIGH:E,LOW:f,CLOSEP:O,YCP:S,CHANGE:m,TRADE:L,VALUE:A,VOLUME:D};t.push(k)}),readDateTime(s,a,t)}else emailTrigger(!0)}})}const{emailTrigger:emailTrigger}=require("./emailtrigger.js");require("dotenv").config();const Parse=require("parse/node"),request=require("request"),cheerio=require("cheerio");Parse.initialize(process.env.APP_ID,process.env.JS_KEY),Parse.serverURL=process.env.SERVER_URL,main();